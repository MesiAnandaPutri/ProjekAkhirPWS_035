<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem API Film Pro</title>
    <style>
        /* --- CSS GLOBAL --- */
        :root { --primary: #1a1d29; --secondary: #252a41; --accent: #007bff; --text: #fff; --code-bg: #1e1e1e; }
        body { background-color: var(--primary); font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--text); overflow-x: hidden; }
        
        /* AUTH PAGE */
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .auth-box { background: var(--secondary); padding: 2rem; border-radius: 12px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; color: #4facfe; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #444; border-radius: 6px; background: #161925; color: white; box-sizing: border-box; font-size: 0.95rem; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        button { width: 100%; padding: 14px; background: linear-gradient(to right, #007bff, #0056b3); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 15px; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,123,255,0.4); }
        
        /* EXTRAS */
        .divider { display: flex; align-items: center; margin: 15px 0; color: #888; font-size: 0.8rem; }
        .divider::before, .divider::after { content: ""; flex: 1; border-bottom: 1px solid #444; }
        .divider span { padding: 0 10px; }
        .toggle-link { margin-top: 20px; font-size: 0.9rem; cursor: pointer; color: #aaa; text-decoration: underline; }
        
        /* MODAL POPUP */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #252a41; padding: 30px; border-radius: 12px; text-align: center; width: 100%; max-width: 450px; border: 1px solid #4facfe; box-shadow: 0 0 20px rgba(79, 172, 254, 0.3); position: relative; }
        .apikey-box { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; word-break: break-all; margin: 15px 0; border: 1px dashed #444; font-size: 1.1rem; }

        /* HEADER */
        #app-container { display: none; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--secondary); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #444; text-transform: uppercase; font-weight: bold;}

        /* --- API EXPLORER STYLES --- */
        #explorer-view { display: none; background: #13151f; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 30px; }
        .explorer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .explorer-grid { grid-template-columns: 1fr; } }
        
        .req-box, .res-box { background: #1e1e2e; padding: 15px; border-radius: 8px; }
        .label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        textarea.code-editor { font-family: 'Consolas', 'Monaco', monospace; background: #0f0f13; border: 1px solid #333; color: #a9b7c6; height: 200px; resize: vertical; font-size: 0.9rem; }
        pre.response-viewer { background: #000; color: #0f0; padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace; height: 350px; overflow: auto; border: 1px solid #333; font-size: 0.85rem; margin: 0; }

        /* --- MOVIE UI (SEARCH & FILTERS) --- */
        .search-wrapper { display: flex; gap: 10px; margin-bottom: 10px; max-width: 600px; margin: 0 auto 10px auto; }
        .search-wrapper input { border-radius: 50px; padding-left: 20px; }
        .search-wrapper button { width: auto; padding: 10px 25px; border-radius: 50px; margin: 8px 0; }

        /* Filter Container (KATEGORI) */
        .filter-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; }
        .filter-btn { padding: 8px 16px; background: #2c3e50; color: white; border: 1px solid #444; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; margin: 0; width: auto; box-shadow: none; }
        .filter-btn:hover, .filter-btn.active { background: #e67e22; border-color: #e67e22; transform: translateY(-2px); }
        .filter-select { padding: 8px 15px; border-radius: 20px; background: #2c3e50; color: white; border: 1px solid #444; width: auto; margin: 0; cursor: pointer; }

        .movie-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .movie { background: var(--secondary); width: 160px; border-radius: 8px; overflow: hidden; transition: 0.3s; cursor: pointer; }
        .movie:hover { transform: translateY(-5px); }
        .movie img { width: 100%; height: 240px; object-fit: cover; }
        .movie-info { padding: 10px; font-size: 0.9rem; text-align: center; }

        /* Movie Detail Modal */
        .movie-detail-layout { display: flex; gap: 20px; text-align: left; }
        .detail-poster-img { width: 150px; border-radius: 8px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: var(--secondary); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #1f2235; color: #ccc; font-size: 0.85rem; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>üéâ Registrasi Berhasil!</h2>
            <p>Salin API Key ini:</p>
            <div id="generated-key" class="apikey-box">...</div>
            <button onclick="closeApiKeyModal()">Salin & Masuk</button>
        </div>
    </div>

    <div id="movie-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 650px;">
            <span class="close-btn" onclick="closeMovieModal()">&times;</span>
            <div class="movie-detail-layout">
                <img id="detail-poster" class="detail-poster-img" src="" alt="">
                <div style="flex:1;">
                    <h2 id="detail-title" style="margin-top:0; color:#f1c40f;">Judul</h2>
                    <p style="color:#aaa;">‚≠ê <span id="detail-rating"></span> | üìÖ <span id="detail-date"></span></p>
                    <p id="detail-text" style="color:#ddd; line-height:1.6; max-height:200px; overflow-y:auto;"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-container">
        <div class="auth-box" id="login-box">
            <h2>Masuk Sistem</h2>
            <input type="text" id="login-user" placeholder="Username">
            <input type="password" id="login-pass" placeholder="Password">
            <div class="divider"><span>ATAU PAKAI KEY</span></div>
            <input type="text" id="login-apikey" placeholder="Tempel API Key">
            <button onclick="handleLogin()">MASUK üöÄ</button>
            <div class="toggle-link" onclick="toggleAuth()">Daftar Akun Baru</div>
        </div>

        <div class="auth-box" id="register-box" style="display: none;">
            <h2>Registrasi</h2>
            <input type="text" id="reg-user" placeholder="Username">
            <input type="password" id="reg-pass" placeholder="Password">
            <select id="reg-role"><option value="user">User</option><option value="admin">Admin</option></select>
            <button onclick="register()">Daftar</button>
            <div class="toggle-link" onclick="toggleAuth()">Sudah punya akun? Login</div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-left">
                <b>User:</b> <span id="display-username">...</span>
                <span id="display-role" class="role-badge">...</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="toggleExplorer()" style="width:auto; margin:0; background:#2ecc71; padding:8px 15px;">üõ† API Explorer</button>
                <button onclick="logout()" style="width:auto; margin:0; background:#e74c3c; padding:8px 15px;">Logout</button>
            </div>
        </header>

        <div id="explorer-view">
            <h2 style="border-bottom:1px solid #333; padding-bottom:10px;">‚ö° API Explorer / Playground</h2>
            <div class="explorer-grid">
                <div class="req-box">
                    <span class="label">1. Pilih Endpoint</span>
                    <select id="api-selector" onchange="loadApiTemplate()">
                        <option value="">-- Pilih API untuk Dites --</option>
                        <option value="POST|/api/register">POST /api/register</option>
                        <option value="POST|/api/login">POST /api/login</option>
                        <option value="POST|/api/login-key">POST /api/login-key</option>
                        <option value="GET|/api/users">GET /api/users</option>
                    </select>
                    <span class="label" style="margin-top:15px;">2. Request Body (JSON)</span>
                    <textarea id="api-body" class="code-editor" placeholder="{ ... }"></textarea>
                    <button onclick="sendApiRequest()">Kirim Request ‚ñ∂</button>
                </div>
                <div class="res-box">
                    <span class="label">3. Server Response</span>
                    <pre id="api-response" class="response-viewer">// Hasil respon server...</pre>
                </div>
            </div>
        </div>

        <div id="main-view">
            <div id="content-area">Loading...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        const TMDB_KEY = '87764673ce6b73c72c2ff32f1a91da7b';
        let currentMovieList = []; 
        let isExplorerOpen = false;

        // --- AUTH ---
        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const k = document.getElementById('login-apikey').value;
            if (k) authRequest(`${API_URL}/login-key`, { apiKey: k });
            else if (u && p) authRequest(`${API_URL}/login`, { username: u, password: p });
            else alert("Isi data login!");
        }

        async function authRequest(url, body) {
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if(res.ok) { localStorage.setItem('user', JSON.stringify(data)); loadApp(data); }
                else alert(data.message);
            } catch(e) { alert("Gagal koneksi server."); }
        }

        async function register() {
            const u = document.getElementById('reg-user').value;
            const p = document.getElementById('reg-pass').value;
            const r = document.getElementById('reg-role').value;
            try {
                const res = await fetch(`${API_URL}/register`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p, role:r}) });
                const data = await res.json();
                if(res.ok) {
                    document.getElementById('generated-key').innerText = data.apiKey;
                    document.getElementById('success-modal').style.display = 'flex';
                } else alert(data.message);
            } catch(e) { alert("Server Error"); }
        }

        // --- API EXPLORER LOGIC ---
        function toggleExplorer() {
            isExplorerOpen = !isExplorerOpen;
            const explorer = document.getElementById('explorer-view');
            const main = document.getElementById('main-view');
            const btn = document.querySelector('header button');

            if(isExplorerOpen) {
                explorer.style.display = 'block'; main.style.display = 'none';
                btn.innerText = "üè† Kembali ke App"; btn.style.background = "#3498db";
            } else {
                explorer.style.display = 'none'; main.style.display = 'block';
                btn.innerText = "üõ† API Explorer"; btn.style.background = "#2ecc71";
            }
        }

        function loadApiTemplate() {
            const val = document.getElementById('api-selector').value;
            const bodyArea = document.getElementById('api-body');
            if(!val) { bodyArea.value = ""; return; }
            const [method, path] = val.split('|');
            if(path.includes('register')) bodyArea.value = JSON.stringify({ username: "tes", password: "123", role: "user" }, null, 2);
            else if(path.includes('login-key')) bodyArea.value = JSON.stringify({ apiKey: "API_KEY_KAMU" }, null, 2);
            else if(path.includes('login')) bodyArea.value = JSON.stringify({ username: "tes", password: "123" }, null, 2);
            else bodyArea.value = "// Tidak butuh body";
        }

        async function sendApiRequest() {
            const val = document.getElementById('api-selector').value;
            const bodyRaw = document.getElementById('api-body').value;
            const output = document.getElementById('api-response');
            if(!val) return alert("Pilih endpoint!");
            const [method, path] = val.split('|');
            output.innerText = "‚è≥ Mengirim...";

            try {
                let options = { method: method, headers: { 'Content-Type': 'application/json' } };
                if(method !== 'GET' && method !== 'DELETE') options.body = bodyRaw;
                const res = await fetch(`http://localhost:3000${path}`, options);
                const data = await res.json();
                output.innerText = `Status: ${res.status}\n\n` + JSON.stringify(data, null, 2);
            } catch(err) { output.innerText = "Error:\n" + err.message; }
        }
