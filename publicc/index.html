<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem API Film Pro</title>
    <style>
        /* --- CSS GLOBAL --- */
        :root { --primary: #1a1d29; --secondary: #252a41; --accent: #007bff; --text: #fff; --code-bg: #1e1e1e; }
        body { background-color: var(--primary); font-family: 'Segoe UI', sans-serif; margin: 0; color: var(--text); overflow-x: hidden; }
        
        /* AUTH PAGE */
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .auth-box { background: var(--secondary); padding: 2rem; border-radius: 12px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; color: #4facfe; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #444; border-radius: 6px; background: #161925; color: white; box-sizing: border-box; font-size: 0.95rem; font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        button { width: 100%; padding: 14px; background: linear-gradient(to right, #007bff, #0056b3); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 15px; font-size: 1rem; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,123,255,0.4); }
        button.secondary-btn { background: #444; box-shadow: none; }
        button.secondary-btn:hover { background: #555; }
        
        /* PANDUAN STEP BY STEP DI REGISTER */
        .steps-guide { 
            text-align: left; 
            background: #1f2235; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            color: #ccc; 
            margin-bottom: 20px; 
            border: 1px solid #444; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .steps-guide h4 { margin: 0 0 8px 0; color: #4facfe; font-size: 0.95rem; }
        .steps-guide ol { padding-left: 20px; margin: 0; }
        .steps-guide li { margin-bottom: 4px; line-height: 1.4; }

        /* EXTRAS */
        .divider { display: flex; align-items: center; margin: 15px 0; color: #888; font-size: 0.8rem; }
        .divider::before, .divider::after { content: ""; flex: 1; border-bottom: 1px solid #444; }
        .divider span { padding: 0 10px; }
        .toggle-link { margin-top: 20px; font-size: 0.9rem; cursor: pointer; color: #aaa; text-decoration: underline; }
        
        /* MODAL POPUP */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #252a41; padding: 30px; border-radius: 12px; text-align: center; width: 100%; max-width: 450px; border: 1px solid #4facfe; box-shadow: 0 0 20px rgba(79, 172, 254, 0.3); position: relative; }
        .apikey-box { background: #000; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; word-break: break-all; margin: 15px 0; border: 1px dashed #444; font-size: 1.1rem; }

        /* STEPPER STYLES DALAM MODAL */
        .step-indicator { font-size: 0.8rem; color: #aaa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* HEADER */
        #app-container { display: none; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; background: var(--secondary); padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #444; text-transform: uppercase; font-weight: bold;}

        /* --- API EXPLORER STYLES --- */
        #explorer-view { display: none; background: #13151f; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 30px; }
        .explorer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .explorer-grid { grid-template-columns: 1fr; } }
        
        .req-box, .res-box { background: #1e1e2e; padding: 15px; border-radius: 8px; }
        .label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        textarea.code-editor { font-family: 'Consolas', 'Monaco', monospace; background: #0f0f13; border: 1px solid #333; color: #a9b7c6; height: 200px; resize: vertical; font-size: 0.9rem; }
        pre.response-viewer { background: #000; color: #0f0; padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace; height: 350px; overflow: auto; border: 1px solid #333; font-size: 0.85rem; margin: 0; }

        /* --- MOVIE UI (SEARCH & FILTERS) --- */
        .search-wrapper { display: flex; gap: 10px; margin-bottom: 10px; max-width: 600px; margin: 0 auto 10px auto; }
        .search-wrapper input { border-radius: 50px; padding-left: 20px; }
        .search-wrapper button { width: auto; padding: 10px 25px; border-radius: 50px; margin: 8px 0; }

        /* Filter Container (KATEGORI) */
        .filter-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; }
        .filter-btn { padding: 8px 16px; background: #2c3e50; color: white; border: 1px solid #444; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 0.9rem; margin: 0; width: auto; box-shadow: none; }
        .filter-btn:hover, .filter-btn.active { background: #e67e22; border-color: #e67e22; transform: translateY(-2px); }
        .filter-select { padding: 8px 15px; border-radius: 20px; background: #2c3e50; color: white; border: 1px solid #444; width: auto; margin: 0; cursor: pointer; }

        .movie-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .movie { background: var(--secondary); width: 160px; border-radius: 8px; overflow: hidden; transition: 0.3s; cursor: pointer; }
        .movie:hover { transform: translateY(-5px); }
        .movie img { width: 100%; height: 240px; object-fit: cover; }
        .movie-info { padding: 10px; font-size: 0.9rem; text-align: center; }

        /* Movie Detail Modal */
        .movie-detail-layout { display: flex; gap: 20px; text-align: left; }
        .detail-poster-img { width: 150px; border-radius: 8px; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: var(--secondary); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background: #1f2235; color: #ccc; font-size: 0.85rem; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="success-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-step-1">
                <div class="step-indicator">Langkah 1 dari 2</div>
                <h2>üéâ Registrasi Berhasil!</h2>
                <p>Ini adalah <b>Kunci Akses (API Key)</b> Anda.<br>Wajib disalin untuk login.</p>
                <div id="generated-key" class="apikey-box">...</div>
                <button onclick="copyKeyNext()">üìÑ Salin API Key</button>
            </div>

            <div id="modal-step-2" style="display: none;">
                <div class="step-indicator">Langkah 2 dari 2</div>
                <h2 style="color: #2ecc71;">‚úÖ Berhasil Disalin!</h2>
                <p>API Key sudah tersimpan di clipboard.</p>
                <p style="color:#aaa; font-size:0.9rem;">Klik tombol di bawah untuk langsung menempelkan Key ke halaman Login.</p>
                <button onclick="autoFillLogin()">üöÄ Tempel & Masuk</button>
                <button onclick="closeModalOnly()" class="secondary-btn" style="margin-top:10px;">Tutup Saja</button>
            </div>
        </div>
    </div>

    <div id="movie-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 650px;">
            <span class="close-btn" onclick="closeMovieModal()">&times;</span>
            <div class="movie-detail-layout">
                <img id="detail-poster" class="detail-poster-img" src="" alt="">
                <div style="flex:1;">
                    <h2 id="detail-title" style="margin-top:0; color:#f1c40f;">Judul</h2>
                    <p style="color:#aaa;">‚≠ê <span id="detail-rating"></span> | üìÖ <span id="detail-date"></span></p>
                    <p id="detail-text" style="color:#ddd; line-height:1.6; max-height:200px; overflow-y:auto;"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-container">
        
        <div class="auth-box" id="login-box">
            <h2>Masuk Sistem</h2>
            <input type="text" id="login-user" placeholder="Username">
            <input type="password" id="login-pass" placeholder="Password">
            <div class="divider"><span>ATAU PAKAI KEY</span></div>
            <input type="text" id="login-apikey" placeholder="Tempel API Key">
            <button onclick="handleLogin()">MASUK üöÄ</button>
            <div class="toggle-link" onclick="toggleAuth()">Daftar Akun Baru</div>
        </div>

        <div class="auth-box" id="register-box" style="display: none;">
            <h2>üìù Registrasi Akun</h2>
            
            <div class="steps-guide">
                <h4>üìã Langkah Pendaftaran:</h4>
                <ol>
                    <li>Isi Username & Password di bawah.</li>
                    <li>Klik tombol <b>Daftar</b>.</li>
                    <li>Sistem akan memberi <b>API Key</b>.</li>
                    <li><b>Salin Key</b> tersebut untuk Login.</li>
                </ol>
            </div>
        
            <input type="text" id="reg-user" placeholder="Username Baru">
            <input type="password" id="reg-pass" placeholder="Password Baru">
            
            <div style="text-align: left; font-size: 0.8rem; color: #aaa; margin-top: 5px;">Pilih Role:</div>
            <select id="reg-role">
                <option value="user">User Biasa</option>
                <option value="admin">Admin</option>
            </select>
        
            <button onclick="register()">Daftar & Dapat Key üîë</button>
            <div class="toggle-link" onclick="toggleAuth()">Sudah punya akun? Login di sini</div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-left">
                <b>User:</b> <span id="display-username">...</span>
                <span id="display-role" class="role-badge">...</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="toggleExplorer()" style="width:auto; margin:0; background:#2ecc71; padding:8px 15px;">üõ† API Explorer</button>
                <button onclick="logout()" style="width:auto; margin:0; background:#e74c3c; padding:8px 15px;">Logout</button>
            </div>
        </header>

        <div id="explorer-view">
            <h2 style="border-bottom:1px solid #333; padding-bottom:10px;">‚ö° API Explorer / Playground</h2>
            <div class="explorer-grid">
                <div class="req-box">
                    <span class="label">1. Pilih Endpoint</span>
                    <select id="api-selector" onchange="loadApiTemplate()">
                        <option value="">-- Pilih API untuk Dites --</option>
                        <option value="POST|/api/register">POST /api/register</option>
                        <option value="POST|/api/login">POST /api/login</option>
                        <option value="POST|/api/login-key">POST /api/login-key</option>
                        <option value="GET|/api/users">GET /api/users</option>
                    </select>
                    <span class="label" style="margin-top:15px;">2. Request Body (JSON)</span>
                    <textarea id="api-body" class="code-editor" placeholder="{ ... }"></textarea>
                    <button onclick="sendApiRequest()">Kirim Request ‚ñ∂</button>
                </div>
                <div class="res-box">
                    <span class="label">3. Server Response</span>
                    <pre id="api-response" class="response-viewer">// Hasil respon server...</pre>
                </div>
            </div>
        </div>

        <div id="main-view">
            <div id="content-area">Loading...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        const TMDB_KEY = '87764673ce6b73c72c2ff32f1a91da7b';
        let currentMovieList = []; 
        let isExplorerOpen = false;
        let tempApiKey = ""; // Variabel sementara untuk menyimpan KEY

        // --- AUTH ---
        async function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const k = document.getElementById('login-apikey').value;
            if (k) authRequest(`${API_URL}/login-key`, { apiKey: k });
            else if (u && p) authRequest(`${API_URL}/login`, { username: u, password: p });
            else alert("Isi data login!");
        }

        async function authRequest(url, body) {
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if(res.ok) { localStorage.setItem('user', JSON.stringify(data)); loadApp(data); }
                else alert(data.message);
            } catch(e) { alert("Gagal koneksi server."); }
        }

        async function register() {
            const u = document.getElementById('reg-user').value;
            const p = document.getElementById('reg-pass').value;
            const r = document.getElementById('reg-role').value;
            try {
                const res = await fetch(`${API_URL}/register`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p, role:r}) });
                const data = await res.json();
                if(res.ok) {
                    // STEP 1: Tampilkan Step 1
                    tempApiKey = data.apiKey; // Simpan di memori
                    document.getElementById('generated-key').innerText = tempApiKey;
                    
                    document.getElementById('modal-step-1').style.display = 'block';
                    document.getElementById('modal-step-2').style.display = 'none';
                    document.getElementById('success-modal').style.display = 'flex';
                } else alert(data.message);
            } catch(e) { alert("Server Error"); }
        }

        // --- FUNGSI BARU UNTUK STEP BY STEP REGISTRASI ---
        function copyKeyNext() {
            // Salin ke clipboard
            navigator.clipboard.writeText(tempApiKey).then(() => {
                // Pindah ke Step 2
                document.getElementById('modal-step-1').style.display = 'none';
                document.getElementById('modal-step-2').style.display = 'block';
            }).catch(err => {
                alert('Gagal menyalin otomatis, silakan blok dan copy manual.');
            });
        }

        function autoFillLogin() {
            document.getElementById('success-modal').style.display = 'none';
            // Pindah tampilan dari Register Box ke Login Box
            toggleAuth(); 
            // Isi otomatis input login
            document.getElementById('login-apikey').value = tempApiKey;
            // Fokuskan kursor ke tombol login atau input (opsional)
            alert("API Key sudah ditempel! Silakan klik Masuk.");
        }

        function closeModalOnly() {
            document.getElementById('success-modal').style.display = 'none';
            toggleAuth(); // Tetap pindah ke login screen
        }

        // --- API EXPLORER LOGIC ---
        function toggleExplorer() {
            isExplorerOpen = !isExplorerOpen;
            const explorer = document.getElementById('explorer-view');
            const main = document.getElementById('main-view');
            const btn = document.querySelector('header button');

            if(isExplorerOpen) {
                explorer.style.display = 'block'; main.style.display = 'none';
                btn.innerText = "üè† Kembali ke App"; btn.style.background = "#3498db";
            } else {
                explorer.style.display = 'none'; main.style.display = 'block';
                btn.innerText = "üõ† API Explorer"; btn.style.background = "#2ecc71";
            }
        }

        function loadApiTemplate() {
            const val = document.getElementById('api-selector').value;
            const bodyArea = document.getElementById('api-body');
            if(!val) { bodyArea.value = ""; return; }
            const [method, path] = val.split('|');
            if(path.includes('register')) bodyArea.value = JSON.stringify({ username: "tes", password: "123", role: "user" }, null, 2);
            else if(path.includes('login-key')) bodyArea.value = JSON.stringify({ apiKey: "API_KEY_KAMU" }, null, 2);
            else if(path.includes('login')) bodyArea.value = JSON.stringify({ username: "tes", password: "123" }, null, 2);
            else bodyArea.value = "// Tidak butuh body";
        }

        async function sendApiRequest() {
            const val = document.getElementById('api-selector').value;
            const bodyRaw = document.getElementById('api-body').value;
            const output = document.getElementById('api-response');
            if(!val) return alert("Pilih endpoint!");
            const [method, path] = val.split('|');
            output.innerText = "‚è≥ Mengirim...";

            try {
                let options = { method: method, headers: { 'Content-Type': 'application/json' } };
                if(method !== 'GET' && method !== 'DELETE') options.body = bodyRaw;
                const res = await fetch(`http://localhost:3000${path}`, options);
                const data = await res.json();
                output.innerText = `Status: ${res.status}\n\n` + JSON.stringify(data, null, 2);
            } catch(err) { output.innerText = "Error:\n" + err.message; }
        }

        // --- STANDARD APP LOGIC ---
        function toggleAuth() {
            const l = document.getElementById('login-box'); const r = document.getElementById('register-box');
            
            // Logika sederhana: jika Login hidden, tampilkan Login. 
            if (l.style.display === 'none') {
                l.style.display = 'block';
                r.style.display = 'none';
            } else {
                l.style.display = 'none';
                r.style.display = 'block';
            }
        }
        
        function closeMovieModal() { document.getElementById('movie-detail-modal').style.display = 'none'; }
        function logout() { localStorage.removeItem('user'); location.reload(); }

        function loadApp(user) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('display-username').innerText = user.username;
            document.getElementById('display-role').innerText = user.role;

            const content = document.getElementById('content-area');
            if(user.role === 'admin') {
                content.innerHTML = `<h2>Dashboard Admin</h2><p>Data User:</p><table id="adm-table"><thead><tr><th>User</th><th>Role</th><th>API Key</th><th>Action</th></tr></thead><tbody id="adm-body"></tbody></table>`;
                loadAdminTable();
            } else {
                // USER DASHBOARD DENGAN SEARCH & FILTER
                content.innerHTML = `
                    <div style="text-align:center;">
                        <h2>üé¨ Cari Film Favorit</h2>
                        <div class="search-wrapper">
                            <input type="text" id="movie-search" placeholder="Cari judul..." style="flex:1;">
                            <button onclick="searchFilm()">Cari</button>
                        </div>
                        
                        <div class="filter-container">
                            <button class="filter-btn active" onclick="filterBy('popular')">üî• Populer</button>
                            <button class="filter-btn" onclick="filterBy('top_rated')">‚≠ê Rating Terbaik</button>
                            <button class="filter-btn" onclick="filterBy('now_playing')">üÜï Terbaru</button>
                            <select id="genre-select" class="filter-select" onchange="filterByGenre()">
                                <option value="">üìÇ Pilih Genre...</option>
                            </select>
                        </div>
                    </div>
                    <div class="movie-grid" id="m-grid">Loading...</div>
                `;
                fetchMovies(`https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_KEY}`);
                loadGenres(); // Panggil fungsi genre
            }
        }

        // --- MOVIE LOGIC (SEARCH & FILTER) ---
        function loadGenres() {
            fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${TMDB_KEY}`)
            .then(r => r.json()).then(data => {
                const select = document.getElementById('genre-select');
                if(!select) return;
                data.genres.forEach(g => {
                    const opt = document.createElement('option'); opt.value = g.id; opt.innerText = g.name;
                    select.appendChild(opt);
                });
            });
        }

        function filterBy(cat) {
            document.getElementById('genre-select').value = ""; document.getElementById('movie-search').value = "";
            let url = `https://api.themoviedb.org/3/movie/${cat}?api_key=${TMDB_KEY}`;
            fetchMovies(url);
        }

        function filterByGenre() {
            const gid = document.getElementById('genre-select').value;
            document.getElementById('movie-search').value = "";
            if(gid) fetchMovies(`https://api.themoviedb.org/3/discover/movie?with_genres=${gid}&api_key=${TMDB_KEY}`);
        }

        function searchFilm() {
            const q = document.getElementById('movie-search').value;
            fetchMovies(q ? `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_KEY}&query=${q}` : `https://api.themoviedb.org/3/movie/popular?api_key=${TMDB_KEY}`);
        }

        function fetchMovies(url) {
            fetch(url).then(r=>r.json()).then(d => {
                currentMovieList = d.results || [];
                const g = document.getElementById('m-grid'); g.innerHTML = '';
                if(!currentMovieList.length) g.innerHTML = '<p>Kosong</p>';
                currentMovieList.forEach((m,i) => {
                    const poster = m.poster_path ? `https://image.tmdb.org/t/p/w300${m.poster_path}` : 'https://via.placeholder.com/200';
                    g.innerHTML += `<div class="movie" onclick="showDetail(${i})"><img src="${poster}"><div class="movie-info"><b>${m.title}</b><br>‚≠ê ${m.vote_average}</div></div>`;
                });
            });
        }
        
        function showDetail(i) {
            const m = currentMovieList[i];
            document.getElementById('detail-poster').src = m.poster_path ? `https://image.tmdb.org/t/p/w500${m.poster_path}` : '';
            document.getElementById('detail-title').innerText = m.title;
            document.getElementById('detail-rating').innerText = m.vote_average;
            document.getElementById('detail-date').innerText = m.release_date;
            document.getElementById('detail-text').innerText = m.overview;
            document.getElementById('movie-detail-modal').style.display = 'flex';
        }

        // --- ADMIN LOGIC ---
        function loadAdminTable() {
            fetch(`${API_URL}/users`).then(r=>r.json()).then(users => {
                const tb = document.getElementById('adm-body'); tb.innerHTML = '';
                const curr = JSON.parse(localStorage.getItem('user'));
                users.forEach(u => {
                    const btn = u.username === curr.username ? '-' : `<button onclick="del('${u.username}')" style="background:red;padding:5px;width:auto;margin:0;">Hapus</button>`;
                    tb.innerHTML += `<tr><td>${u.username}</td><td>${u.role}</td><td><code style="color:#aaa">${u.apiKey}</code></td><td>${btn}</td></tr>`;
                });
            });
        }
        async function del(n) { if(confirm('Hapus?')) { await fetch(`${API_URL}/users/${n}`, {method:'DELETE'}); loadAdminTable(); } }

        const saved = localStorage.getItem('user');
        if(saved) loadApp(JSON.parse(saved));
    </script>
</body>
</html>